# SPN VPN Bot

Telegram бот для управления VPN подписками с поддержкой платежей через CryptoBot и интеграцией с Remnawave API.

## Структура проекта

```
project_root/
├── main.py                 # Точка входа приложения
├── config.py              # Конфигурация и переменные окружения
├── database.py            # Работа с базой данных SQLite
├── states.py              # FSM состояния
├── .env                   # Переменные окружения
├── requirements.txt       # Зависимости Python
├── handlers/              # Обработчики команд и callback'ов
│   ├── __init__.py
│   ├── start.py          # Команда /start и главное меню
│   ├── callbacks.py      # Общие callback обработчики
│   ├── subscription.py   # Покупка и продление подписок
│   ├── gift.py           # Получение подарка
│   ├── referral.py       # Реферальная программа
│   ├── promo.py          # Промокоды
│   └── admin.py          # Админ команды
└── services/              # Сервисы и интеграции
    ├── __init__.py
    ├── remnawave.py      # Интеграция с Remnawave API
    └── cryptobot.py      # Интеграция с CryptoBot API
```

## Установка

### Требования
- Python 3.10+
- pip или другой package manager

### Шаги установки

1. **Клонируйте репозиторий:**
```bash
git clone <your-repo>
cd spn-vpn-bot
```

2. **Установите зависимости:**
```bash
pip install -r requirements.txt
```

3. **Настройте переменные окружения:**
Отредактируйте файл `.env` и добавьте необходимые значения:
```env
BOT_TOKEN=your_telegram_bot_token
ADMIN_ID=your_admin_telegram_id
# ... остальные переменные
```

## Запуск

### Локальный запуск на macOS

```bash
# Убедитесь что вы в корне проекта
python3 main.py
```

Бот будет работать в режиме polling (прослушивание обновлений от Telegram).

## Функциональность

### Пользовательские функции
- ✅ Выбор и оплата подписок
- ✅ Интеграция с Remnawave для управления VPN аккаунтами
- ✅ Платежи через CryptoBot (USDT, TON, BTC)
- ✅ Реферальная программа (получение бонусов за приглашённых друзей)
- ✅ Промокоды
- ✅ Подарки за подписку на канал новостей
- ✅ Просмотр статуса подписки

### Администраторские команды
- `/new_code CODE DAYS LIMIT` - Создать новый промокод
- `/give_sub TG_ID DAYS` - Выдать подписку пользователю
- `/stats` - Получить статистику (в разработке)

## Конфигурация

### Переменные окружения (.env)

| Переменная | Описание |
|-----------|---------|
| `BOT_TOKEN` | Токен Telegram бота |
| `ADMIN_ID` | ID администратора Telegram |
| `SUPPORT_URL` | URL поддержки (Telegram ссылка) |
| `NEWS_CHANNEL_USERNAME` | Имя канала новостей |
| `TELEGRAPH_AGREEMENT_URL` | Ссылка на условия использования |
| `REMNAWAVE_BASE_URL` | URL API Remnawave |
| `REMNAWAVE_API_TOKEN` | API токен Remnawave |
| `DEFAULT_SQUAD_UUID` | UUID сквада по умолчанию |
| `CRYPTOBOT_TOKEN` | Токен CryptoBot |
| `CRYPTOBOT_API_URL` | URL API CryptoBot |
| `DB_FILE` | Путь к файлу базы данных SQLite |
| `LOG_LEVEL` | Уровень логирования (INFO, DEBUG, WARNING и т.д.) |

## Архитектура

### Модули

**config.py** - Загружает переменные окружения и определяет конфигурацию приложения

**database.py** - Работает с SQLite базой данных:
- Управление пользователями
- Управление платежами
- Управление промокодами
- Система блокировок для защиты от race conditions

**states.py** - Определяет FSM состояния для управления диалогами с пользователями

**handlers/** - Модули обработчиков:
- `start.py` - Инициализация бота и главное меню
- `subscription.py` - Покупка и управление подписками
- `gift.py` - Система подарков
- `referral.py` - Реферальная программа
- `promo.py` - Система промокодов
- `callbacks.py` - Общие callback обработчики
- `admin.py` - Администраторские команды

**services/** - Сервисы для интеграций:
- `remnawave.py` - Управление VPN аккаунтами через Remnawave API
- `cryptobot.py` - Обработка платежей через CryptoBot API с фоновой проверкой

## Безопасность

- ✅ Использование переменных окружения для секретных данных
- ✅ Система блокировок в БД для предотвращения race conditions
- ✅ Проверка прав администратора перед выполнением админ команд
- ✅ Проверка подписки на канал перед выдачей подарков

## Лицензия

MIT

## Поддержка

Для вопросов и поддержки обращайтесь через Telegram.
